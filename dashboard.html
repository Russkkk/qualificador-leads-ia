<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Qualificador de Leads IA</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1:#0b1020; --bg2:#111b3a;
      --panel:#0f172a; --panel2:#0b1224;
      --border:#243047;
      --text:#e5e7eb; --muted:#94a3b8;
      --primary:#2563eb; --green:#22c55e; --red:#ef4444; --yellow:#eab308;
      --radius:14px;
      --shadow:0 18px 50px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:22px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 520px at 20% 10%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(900px 480px at 80% 20%, rgba(34,197,94,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; margin-bottom:16px;
    }
    h1{ margin:0; font-size:20px; letter-spacing:-.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:4px; }

    .topbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .input, select{
      background: rgba(2,6,23,.45);
      border:1px solid rgba(36,48,71,.95);
      color:var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      min-width: 220px;
    }
    select{ min-width: 180px; }

    .btn{
      border:none; cursor:pointer;
      padding: 10px 14px;
      border-radius: 12px;
      background: linear-gradient(180deg, #2563eb, #1d4ed8);
      color:white;
      font-weight:700;
    }
    .btnSecondary{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color: var(--text);
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight:600;
    }
    .btnSmall{
      padding: 7px 10px;
      border-radius: 10px;
      font-weight:700;
      font-size: 12px;
    }
    .btnGreen{ background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35); color:#dcfce7; }
    .btnRed{ background: rgba(239,68,68,.16); border:1px solid rgba(239,68,68,.32); color:#fee2e2; }
    .btnDisabled{ opacity:.55; cursor:not-allowed; }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap:12px;
      margin: 14px 0 18px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(148,163,184,.16);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card span{ color:var(--muted); font-size: 12px; }
    .card strong{ display:block; font-size: 24px; margin-top:4px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.65fr;
      gap:14px;
      align-items:start;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(148,163,184,.16);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .panel h3{ margin:0 0 10px; font-size: 14px; color:#cbd5e1; }

    .row2{
      display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px;
    }
    .search{
      flex: 1;
      min-width: 220px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      background: rgba(2,6,23,.45);
      border:1px solid rgba(36,48,71,.95);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(36,48,71,.75);
      font-size: 13px;
      text-align:left;
      vertical-align: middle;
    }
    th{
      color: var(--muted);
      font-weight: 600;
      background: rgba(2,6,23,.55);
    }
    tr:hover{ background: rgba(148,163,184,.06); }

    .tag{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.2px;
      border:1px solid rgba(148,163,184,.18);
    }
    .tConv{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35); color:#dcfce7; }
    .tNeg{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.33); color:#fee2e2; }
    .tPen{ background: rgba(234,179,8,.14); border-color: rgba(234,179,8,.35); color:#fef3c7; }

    .muted{ color: var(--muted); }

    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 12px 14px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.75);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      display:none;
      max-width: 380px;
      line-height: 1.35;
    }
    .toast.show{ display:block; }
    .toast.success{ border-color: rgba(34,197,94,.35); }
    .toast.error{ border-color: rgba(239,68,68,.35); }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>üìä Dashboard ‚Äî Qualificador de Leads IA</h1>
      <div class="sub">Filtro, busca, exporta√ß√£o CSV e a√ß√µes r√°pidas</div>
    </div>

    <div class="topbar">
      <input id="clientId" class="input" placeholder="client_id" />
      <button class="btn" id="btnLoad">Atualizar</button>
      <button class="btnSecondary" id="btnExport">Exportar CSV</button>
      <button class="btnSecondary" id="btnLogout">Limpar client_id</button>
    </div>
  </header>

  <section class="cards">
    <div class="card"><span>Total de leads</span><strong id="kpiTotal">0</strong></div>
    <div class="card"><span>Convertidos</span><strong id="kpiConv">0</strong></div>
    <div class="card"><span>Pendentes</span><strong id="kpiPen">0</strong></div>
    <div class="card"><span>Negados</span><strong id="kpiNeg">0</strong></div>
    <div class="card"><span>Taxa de convers√£o</span><strong id="kpiRate">0%</strong></div>
  </section>

  <section class="grid">
    <div class="panel">
      <h3>Status dos leads</h3>
      <canvas id="chart"></canvas>
      <div class="muted" style="margin-top:10px;font-size:12px;">
        Dica: ‚ÄúPendentes‚Äù s√£o leads ainda sem confirma√ß√£o (virou_cliente = -1).
      </div>
    </div>

    <div class="panel">
      <h3>Leads</h3>

      <div class="row2">
        <select id="filtro">
          <option value="todos">Todos</option>
          <option value="convertidos">Convertidos</option>
          <option value="pendentes">Pendentes</option>
          <option value="negados">Negados</option>
        </select>

        <input id="busca" class="input search" placeholder="Buscar por ID (ex: 12)..." />
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:70px;">ID</th>
              <th>Tempo (s)</th>
              <th>P√°ginas</th>
              <th>Clicou pre√ßo</th>
              <th>Status</th>
              <th style="width:220px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px;">
        * Export CSV usa os dados j√° carregados do endpoint <code>/dashboard_data</code>. :contentReference[oaicite:2]{index=2}
      </div>
    </div>
  </section>

  <div id="toast" class="toast"></div>

<script>
  const API_BASE = "https://qualificador-leads-i-a.onrender.com"; // seu backend Python
  const elClient = document.getElementById("clientId");
  const elFiltro = document.getElementById("filtro");
  const elBusca  = document.getElementById("busca");
  const elTbody  = document.getElementById("tbody");
  const toast    = document.getElementById("toast");

  const saved = localStorage.getItem("client_id");
  if (saved) elClient.value = saved;

  let leads = [];
  let chart = null;

  function showToast(msg, type="success"){
    toast.className = "toast show " + (type === "error" ? "error" : "success");
    toast.innerHTML = msg;
    clearTimeout(window.__t);
    window.__t = setTimeout(() => toast.className = "toast", 3200);
  }

  function statusInfo(v){
    if (v === 1) return { label:"‚úÖ Convertido", cls:"tConv" };
    if (v === 0) return { label:"‚ùå Negado", cls:"tNeg" };
    return { label:"‚è≥ Pendente", cls:"tPen" };
  }

  function computeKPIs(){
    const total = leads.length;
    const conv = leads.filter(l => l.virou_cliente === 1).length;
    const neg  = leads.filter(l => l.virou_cliente === 0).length;
    const pen  = leads.filter(l => l.virou_cliente !== 1 && l.virou_cliente !== 0).length;

    document.getElementById("kpiTotal").textContent = total;
    document.getElementById("kpiConv").textContent  = conv;
    document.getElementById("kpiNeg").textContent   = neg;
    document.getElementById("kpiPen").textContent   = pen;

    const rate = total ? Math.round((conv / total) * 100) : 0;
    document.getElementById("kpiRate").textContent = rate + "%";

    drawChart(conv, pen, neg);
  }

  function drawChart(conv, pen, neg){
    const ctx = document.getElementById("chart");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Convertidos", "Pendentes", "Negados"],
        datasets: [{
          data: [conv, pen, neg]
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: "#cbd5e1" } }
        }
      }
    });
  }

  function applyFilters(){
    const filtro = elFiltro.value;
    const q = elBusca.value.trim();

    let arr = [...leads];

    // filtro por status
    if (filtro === "convertidos") arr = arr.filter(l => l.virou_cliente === 1);
    if (filtro === "negados")     arr = arr.filter(l => l.virou_cliente === 0);
    if (filtro === "pendentes")   arr = arr.filter(l => l.virou_cliente !== 1 && l.virou_cliente !== 0);

    // busca por ID
    if (q){
      const id = parseInt(q, 10);
      if (!Number.isNaN(id)) arr = arr.filter(l => l.id === id);
    }

    renderTable(arr);
  }

  function renderTable(arr){
    elTbody.innerHTML = "";
    if (!arr.length){
      elTbody.innerHTML = `<tr><td colspan="6" class="muted">Nenhum lead encontrado.</td></tr>`;
      return;
    }

    arr.forEach(l => {
      const st = statusInfo(l.virou_cliente);

      // a√ß√µes: confirmar venda (backend tem endpoint) e negar (backend N√ÉO tem ainda)
      const canConfirm = l.virou_cliente !== 1;
      const canNegar   = true; // vai ficar "desabilitado" at√© voc√™ criar endpoint

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.id}</td>
        <td>${l.tempo_site ?? "-"}</td>
        <td>${l.paginas_visitadas ?? "-"}</td>
        <td>${(l.clicou_preco === 1) ? "Sim" : "N√£o"}</td>
        <td><span class="tag ${st.cls}">${st.label}</span></td>
        <td style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btnSecondary btnSmall btnGreen ${canConfirm ? "" : "btnDisabled"}"
                  ${canConfirm ? "" : "disabled"}
                  onclick="confirmarVenda(${l.id})">
            Confirmar venda
          </button>

          <button class="btnSecondary btnSmall btnRed btnDisabled"
                  title="Upgrade: criar endpoint /negar_venda para marcar virou_cliente=0"
                  disabled>
            Marcar negado
          </button>
        </td>
      `;
      elTbody.appendChild(tr);
    });
  }

  async function carregar(){
    const clientId = elClient.value.trim();
    if (!clientId){
      showToast("Informe o <b>client_id</b> para carregar os dados.", "error");
      return;
    }

    localStorage.setItem("client_id", clientId);

    try{
      const res = await fetch(`${API_BASE}/dashboard_data?client_id=${encodeURIComponent(clientId)}`);
      if (!res.ok){
        const t = await res.text();
        throw new Error(t || "Falha ao carregar");
      }
      const data = await res.json();

      // Seu backend retorna os leads em data.dados. :contentReference[oaicite:3]{index=3}
      leads = (data.dados || []).map(x => ({
        ...x,
        // garante num√©rico
        virou_cliente: Number(x.virou_cliente)
      }));

      computeKPIs();
      applyFilters();
      showToast("Dados carregados com sucesso ‚úÖ");
    } catch (e){
      showToast("Erro ao carregar dados. Verifique o backend no Render.", "error");
    }
  }

  async function confirmarVenda(leadId){
    const clientId = elClient.value.trim();
    if (!clientId) return;

    try{
      const res = await fetch(`${API_BASE}/confirmar_venda`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: clientId, lead_id: leadId })
      });

      if (!res.ok){
        const t = await res.text();
        throw new Error(t || "Falha ao confirmar");
      }

      showToast(`Venda confirmada para o lead <b>#${leadId}</b> ‚úÖ`);
      // recarrega para atualizar status
      await carregar();
    } catch (e){
      showToast("Erro ao confirmar venda. Veja logs do Render.", "error");
    }
  }

  function exportCSV(){
    if (!leads.length){
      showToast("N√£o h√° dados para exportar.", "error");
      return;
    }

    const headers = ["id","tempo_site","paginas_visitadas","clicou_preco","virou_cliente"];
    const rows = leads.map(l => headers.map(h => (l[h] ?? "")).join(","));
    const csv = [headers.join(","), ...rows].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "leads.csv";
    a.click();
    URL.revokeObjectURL(url);

    showToast("CSV exportado üìÑ");
  }

  document.getElementById("btnLoad").addEventListener("click", carregar);
  document.getElementById("btnExport").addEventListener("click", exportCSV);

  document.getElementById("btnLogout").addEventListener("click", () => {
    localStorage.removeItem("client_id");
    elClient.value = "";
    leads = [];
    computeKPIs();
    applyFilters();
    showToast("client_id removido do navegador.");
  });

  elFiltro.addEventListener("change", applyFilters);
  elBusca.addEventListener("input", applyFilters);

  // auto-load se tiver client_id salvo
  if (saved) carregar();
</script>
</body>
</html>
