<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeadRank ‚Äî Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.45);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --hot: #22c55e;
      --warm: #f59e0b;
      --cold: #94a3b8;
      --danger: #ef4444;
      --primary: #60a5fa;
      --primary2: #2563eb;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 15% 10%, rgba(96,165,250,0.20), transparent 60%),
                  radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,0.16), transparent 60%),
                  radial-gradient(900px 600px at 65% 90%, rgba(245,158,11,0.14), transparent 60%),
                  var(--bg);
      color: var(--text);
      padding: 22px;
    }
    .container{ max-width: 1180px; margin: 0 auto; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap: 10px; min-width: 220px; }
    .logo{
      width: 36px; height: 36px; border-radius: 12px;
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(34,197,94,1));
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .brand h1{ font-size: 16px; margin:0; line-height: 1.1; letter-spacing: 0.2px;}
    .brand p{ margin: 2px 0 0; color: var(--muted); font-size: 12px;}
    .controls{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
    .input, .select{
      height: 38px; padding: 0 12px; border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text); outline: none;
    }
    .input::placeholder{ color: rgba(255,255,255,0.45); }
    .btn{
      height: 38px; padding: 0 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text); cursor: pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap: 8px;
      user-select: none; white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.20); }
    .btn:active{ transform: scale(0.98); }
    .btn.primary{ background: linear-gradient(135deg, rgba(96,165,250,0.95), rgba(37,99,235,0.95)); border-color: rgba(0,0,0,0); }
    .btn.primary:hover{ filter: brightness(1.05); }
    .btn.danger{ background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.25); }
    .btn.good{ background: rgba(34,197,94,0.14); border-color: rgba(34,197,94,0.25); }
    .btn.small{ height: 32px; border-radius: 10px; padding: 0 10px; font-size: 13px; }
    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-top: 16px; }
    .card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(8px);
    }
    .kpi{ grid-column: span 3; }
    .kpi .value{ font-size: 26px; font-weight: 800; letter-spacing: 0.2px; }
    .kpi .label{ color: var(--muted); font-size: 12px; margin-top: 4px; }
    .kpi .hint{ color: var(--muted2); font-size: 12px; margin-top: 8px; }
    .panel{ grid-column: span 12; padding: 0; overflow: hidden; }
    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    }
    .panelHeader h2{ margin:0; font-size: 14px; letter-spacing: 0.2px; }
    .panelHeader .sub{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .panelHeaderLeft{ display:flex; flex-direction:column; gap:2px; }
    .panelHeaderRight{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; justify-content:flex-end; }
    .split{ display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 14px; padding: 14px; }
    .split > .card{ box-shadow:none; }
    .chartWrap{ height: 260px; }
    canvas{ width: 100% !important; height: 100% !important; }
    .tableWrap{ overflow:auto; max-height: 520px; border-top: 1px solid var(--border); }
    table{ width: 100%; border-collapse: collapse; min-width: 920px; }
    thead th{
      position: sticky; top: 0; z-index: 5;
      background: rgba(2,6,23,0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      font-size: 12px; color: rgba(255,255,255,0.75);
      padding: 12px 10px; text-align: left; letter-spacing: 0.2px;
    }
    tbody td{ border-bottom: 1px solid rgba(255,255,255,0.08); padding: 12px 10px; font-size: 13px; vertical-align: middle; }
    tbody tr{ background: rgba(255,255,255,0.03); cursor: pointer; transition: background .12s ease; }
    tbody tr:hover{ background: rgba(255,255,255,0.06); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: var(--muted); }
    .pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 12px; color: rgba(255,255,255,0.85);
      white-space: nowrap;
    }
    .pill.hot{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.12); }
    .pill.warm{ border-color: rgba(245,158,11,0.35); background: rgba(245,158,11,0.12); }
    .pill.cold{ border-color: rgba(148,163,184,0.35); background: rgba(148,163,184,0.10); }
    .pill.pending{ border-color: rgba(96,165,250,0.35); background: rgba(96,165,250,0.10); }
    .pill.converted{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.10); }
    .pill.denied{ border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.10); }
    .scoreWrap{ display:flex; align-items:center; gap: 10px; }
    .bar{
      width: 120px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow: hidden; border: 1px solid rgba(255,255,255,0.10);
    }
    .bar > div{ height: 100%; width: 0%; background: linear-gradient(90deg, rgba(96,165,250,0.85), rgba(34,197,94,0.85)); }
    .actions{ display:flex; gap: 8px; justify-content:flex-end; }
    .link{ color: rgba(96,165,250,0.95); text-decoration: none; }
    .link:hover{ text-decoration: underline; }
    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px;
      background: rgba(2,6,23,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 10px 12px; border-radius: 999px;
      color: rgba(255,255,255,0.9);
      box-shadow: var(--shadow);
      display:none; gap: 8px; align-items:center;
      z-index: 999;
      max-width: 92vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .drawerOverlay{ position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; z-index: 200; }
    .drawer{
      position: fixed; top: 0; right: 0; height: 100%;
      width: min(520px, 96vw);
      background: rgba(2,6,23,0.96);
      border-left: 1px solid rgba(255,255,255,0.14);
      box-shadow: -20px 0 40px rgba(0,0,0,0.4);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index: 250;
      display:flex; flex-direction:column;
    }
    .drawerHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;
    }
    .drawerHeader h3{ margin:0; font-size: 14px; }
    .drawerHeader p{ margin: 6px 0 0; color: var(--muted); font-size: 12px; }
    .drawerBody{ padding: 14px; overflow:auto; }
    .row{ display:flex; align-items:center; justify-content:space-between; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.10); gap: 12px; }
    .row .k{ color: var(--muted); font-size: 12px; }
    .row .v{ color: var(--text); font-size: 13px; text-align:right; }
    .drawerFooter{
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,0.12);
      display:flex; gap: 10px; justify-content:flex-end; flex-wrap:wrap;
    }
    @media (max-width: 980px){
      .kpi{ grid-column: span 6; }
      .split{ grid-template-columns: 1fr; }
      .brand{ min-width: 180px; }
    }
    @media (max-width: 560px){
      body{ padding: 14px; }
      .kpi{ grid-column: span 12; }
      .controls{ justify-content: stretch; }
      .input{ width: 100%; }
      .topbar{ top: 10px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LeadRank</h1>
          <p>Dashboard ‚Äî priorize quem vai comprar</p>
        </div>
      </div>

      <div class="controls">
        <input class="input" id="clientId" placeholder="client_id (ex: teste1)" />
        <input class="input" id="search" placeholder="buscar por nome/email/telefone" />
        <select class="select" id="view">
          <option value="ranking">Ranking</option>
          <option value="pendentes">Pendentes</option>
          <option value="rotulados">Rotulados</option>
          <option value="todos">Todos</option>
        </select>
        <button class="btn primary" id="btnCarregar">Carregar</button>
        <button class="btn" id="btnRecalc" title="Recalcula probabilidades dos pendentes">Recalcular</button>
        <button class="btn" id="btnAutoTh" title="Calcula e salva o melhor threshold para este cliente">Auto threshold</button>
      </div>
    </div>

    <div class="grid">
      <div class="card kpi">
        <div class="value" id="kpiTotal">0</div>
        <div class="label">Total de leads (√∫ltimos 200)</div>
        <div class="hint" id="kpiUpdated">‚Äî</div>
      </div>
      <div class="card kpi">
        <div class="value" id="kpiHot">0</div>
        <div class="label">üî• Quentes (score alto)</div>
        <div class="hint">Recomenda√ß√£o de prioridade</div>
      </div>
      <div class="card kpi">
        <div class="value" id="kpiWarm">0</div>
        <div class="label">üü° Mornos</div>
        <div class="hint">Valem follow-up</div>
      </div>
      <div class="card kpi">
        <div class="value" id="kpiCold">0</div>
        <div class="label">‚ùÑÔ∏è Frios</div>
        <div class="hint">Baixa chance</div>
      </div>

      <div class="card panel">
        <div class="panelHeader">
          <div class="panelHeaderLeft">
            <h2>Ranking de leads</h2>
            <div class="sub" id="subTitle">Carregue um client_id para ver o ranking.</div>
          </div>
          <div class="panelHeaderRight">
            <span class="pill" id="pillThreshold">threshold: ‚Äî</span>
            <span class="pill" id="pillCounts">convertidos: ‚Äî | negados: ‚Äî | pendentes: ‚Äî</span>
          </div>
        </div>

        <div class="split">
          <div class="card" style="background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.10);">
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 8px;">
              <div>
                <div style="font-weight:700;">√öltimos 200</div>
                <div style="color:var(--muted); font-size:12px;">Distribui√ß√£o por score (Quente/Morno/Frio)</div>
              </div>
              <a class="link" href="#" id="btnExport">Exportar CSV</a>
            </div>
            <div class="chartWrap">
              <canvas id="grafico"></canvas>
            </div>
          </div>

          <div class="card" style="background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.10);">
            <div style="font-weight:700; margin-bottom: 10px;">A√ß√µes r√°pidas</div>
            <div style="color:var(--muted); font-size:12px; line-height:1.5;">
              ‚Ä¢ Clique em um lead para ver detalhes<br/>
              ‚Ä¢ Marque ‚úÖ/‚ùå para treinar a IA<br/>
              ‚Ä¢ ‚ÄúRecalcular‚Äù atualiza scores dos pendentes<br/>
              ‚Ä¢ ‚ÄúAuto threshold‚Äù ajusta o corte automaticamente
            </div>
            <div style="margin-top: 12px; display:flex; gap: 10px; flex-wrap:wrap;">
              <button class="btn small" id="btnAll">Todos</button>
              <button class="btn small" id="btnPend">Pendentes</button>
              <button class="btn small" id="btnRot">Rotulados</button>
            </div>
            <div style="margin-top: 14px; border-top: 1px solid rgba(255,255,255,0.10); padding-top: 12px;">
              <div class="mono">Backend:</div>
              <div class="mono" id="backendLabel">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:90px;">Prioridade</th>
                <th>Lead</th>
                <th style="width:190px;">Score</th>
                <th style="width:170px;">Status</th>
                <th style="width:220px; text-align:right;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="drawerOverlay" id="drawerOverlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHeader">
      <div>
        <h3 id="dTitle">Lead</h3>
        <p id="dSub">‚Äî</p>
      </div>
      <button class="btn small" id="btnClose">Fechar</button>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
    <div class="drawerFooter">
      <button class="btn good" id="dConfirm">‚úÖ Virou cliente</button>
      <button class="btn danger" id="dDeny">‚ùå N√£o virou</button>
      <a class="btn" id="dCall" href="#" target="_blank" rel="noreferrer">üìû Ligar</a>
      <a class="btn" id="dWhats" href="#" target="_blank" rel="noreferrer">üí¨ WhatsApp</a>
    </div>
  </div>

<script>
  // ‚úÖ Ajuste aqui se mudar o dom√≠nio do backend (Python service).
  const BACKEND = "https://qualificador-leads-i-a.onrender.com";

  // Faixas visuais (UX). O threshold real pode variar (auto_threshold).
  const HOT_MIN  = 0.70;
  const WARM_MIN = 0.40;

  let chart = null;
  let leads = [];
  let currentLead = null;
  let savedThreshold = null;

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "flex";
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>{ t.style.display="none"; }, 2600);
  }

  function fmtPct(p){
    if (p === null || p === undefined || Number.isNaN(p)) return "‚Äî";
    const v = Math.max(0, Math.min(1, Number(p)));
    return Math.round(v*100) + "%";
  }

  function scoreBand(prob){
    const p = Number(prob);
    if (!Number.isFinite(p)) return {key:"cold", label:"‚ùÑÔ∏è Frio", cls:"cold"};
    if (p >= HOT_MIN) return {key:"hot", label:"üî• Quente", cls:"hot"};
    if (p >= WARM_MIN) return {key:"warm", label:"üü° Morno", cls:"warm"};
    return {key:"cold", label:"‚ùÑÔ∏è Frio", cls:"cold"};
  }

  function statusPill(virou){
    if (virou === 1) return {label:"‚úÖ Convertido", cls:"converted"};
    if (virou === 0) return {label:"‚ùå Negado", cls:"denied"};
    return {label:"‚è≥ Pendente", cls:"pending"};
  }

  function safeStr(x){ return (x === null || x === undefined) ? "" : String(x); }
  function normalize(s){ return safeStr(s).toLowerCase().trim(); }

  function openDrawer(lead){
    currentLead = lead;

    const name = lead.nome || "(sem nome)";
    const prob = lead.probabilidade;
    const band = scoreBand(prob);
    const status = statusPill(lead.virou_cliente);

    document.getElementById("dTitle").textContent = `${name} ‚Äî ${fmtPct(prob)} ${band.label}`;
    document.getElementById("dSub").textContent = `Lead #${lead.id} ‚Ä¢ ${status.label} ‚Ä¢ ${lead.created_at || ""}`;

    const rows = [
      ["Probabilidade", fmtPct(prob)],
      ["Tempo no site", `${lead.tempo_site ?? "‚Äî"}s`],
      ["P√°ginas visitadas", lead.paginas_visitadas ?? "‚Äî"],
      ["Clicou em pre√ßo", lead.clicou_preco ? "Sim" : "N√£o"],
      ["Telefone", lead.telefone || "‚Äî"],
      ["Email", lead.email_lead || "‚Äî"]
    ];
    document.getElementById("drawerBody").innerHTML = rows.map(([k,v]) => `
      <div class="row"><div class="k">${k}</div><div class="v">${v}</div></div>
    `).join("");

    const tel = safeStr(lead.telefone).replace(/\D/g,'');
    const call = document.getElementById("dCall");
    const whats = document.getElementById("dWhats");

    call.href = tel ? `tel:${tel}` : "#";
    call.style.opacity = tel ? "1" : "0.5";
    call.style.pointerEvents = tel ? "auto" : "none";

    const msg = encodeURIComponent(`Oi ${name}! Vi seu interesse e queria te ajudar rapidinho üòä`);
    whats.href = tel ? `https://wa.me/55${tel}?text=${msg}` : "#";
    whats.style.opacity = tel ? "1" : "0.5";
    whats.style.pointerEvents = tel ? "auto" : "none";

    const labeled = (lead.virou_cliente === 0 || lead.virou_cliente === 1);
    const btnC = document.getElementById("dConfirm");
    const btnD = document.getElementById("dDeny");
    btnC.disabled = labeled; btnD.disabled = labeled;
    btnC.style.opacity = labeled ? "0.5" : "1";
    btnD.style.opacity = labeled ? "0.5" : "1";

    document.getElementById("drawerOverlay").style.display = "block";
    document.getElementById("drawer").style.transform = "translateX(0)";
  }

  function closeDrawer(){
    document.getElementById("drawerOverlay").style.display = "none";
    document.getElementById("drawer").style.transform = "translateX(100%)";
    currentLead = null;
  }

  function downloadCSV(rows){
    const headers = ["id","nome","email_lead","telefone","probabilidade","virou_cliente","tempo_site","paginas_visitadas","clicou_preco","created_at"];
    const esc = (v) => `"${String(v ?? "").replace(/"/g,'""')}"`;
    const csv = [headers.join(",")].concat(rows.map(r => headers.map(h => esc(r[h])).join(","))).join("\n");
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `leadrank_${(document.getElementById("clientId").value || "cliente")}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function api(path, opts={}){
    const url = BACKEND + path;
    const res = await fetch(url, opts);
    let data = null;
    try{ data = await res.json(); } catch(e){}
    if (!res.ok){
      const msg = (data && (data.error || data.reason)) ? (data.error || data.reason) : `Erro HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function computeKpis(rows){
    let hot=0, warm=0, cold=0;
    for (const l of rows){
      const band = scoreBand(l.probabilidade);
      if (band.key === "hot") hot++;
      else if (band.key === "warm") warm++;
      else cold++;
    }
    return {hot, warm, cold, total: rows.length};
  }

  function applyViewFilter(rows){
    const view = document.getElementById("view").value;
    if (view === "ranking"){
      return rows.slice().sort((a,b) => (Number(b.probabilidade||0) - Number(a.probabilidade||0)));
    }
    if (view === "pendentes"){
      return rows.filter(l => !(l.virou_cliente === 0 || l.virou_cliente === 1))
                 .sort((a,b) => (Number(b.probabilidade||0) - Number(a.probabilidade||0)));
    }
    if (view === "rotulados"){
      return rows.filter(l => (l.virou_cliente === 0 || l.virou_cliente === 1))
                 .sort((a,b) => (b.id - a.id));
    }
    return rows.slice().sort((a,b) => (b.id - a.id));
  }

  function applySearch(rows){
    const q = normalize(document.getElementById("search").value);
    if (!q) return rows;
    return rows.filter(l => {
      const hay = `${l.nome||""} ${l.email_lead||""} ${l.telefone||""} #${l.id}`.toLowerCase();
      return hay.includes(q);
    });
  }

  function renderRowActions(l){
    const tel = safeStr(l.telefone).replace(/\D/g,'');
    const hasTel = !!tel;
    const labeled = (l.virou_cliente === 0 || l.virou_cliente === 1);

    const callBtn = hasTel ? `<a class="btn small" href="tel:${tel}" onclick="event.stopPropagation()">üìû</a>` : `<a class="btn small" href="#" style="opacity:.5;pointer-events:none;" onclick="event.stopPropagation()">üìû</a>`;
    const msg = encodeURIComponent(`Oi ${l.nome||""}! Vi seu interesse e queria te ajudar rapidinho üòä`);
    const waBtn = hasTel ? `<a class="btn small" href="https://wa.me/55${tel}?text=${msg}" target="_blank" rel="noreferrer" onclick="event.stopPropagation()">üí¨</a>`
                         : `<a class="btn small" href="#" style="opacity:.5;pointer-events:none;" onclick="event.stopPropagation()">üí¨</a>`;

    const confirmBtn = labeled ? `<button class="btn small good" data-action="confirm" disabled style="opacity:.5;" onclick="event.stopPropagation()">‚úÖ</button>`
                               : `<button class="btn small good" data-action="confirm" onclick="event.stopPropagation()">‚úÖ</button>`;
    const denyBtn = labeled ? `<button class="btn small danger" data-action="deny" disabled style="opacity:.5;" onclick="event.stopPropagation()">‚ùå</button>`
                            : `<button class="btn small danger" data-action="deny" onclick="event.stopPropagation()">‚ùå</button>`;

    return `${callBtn}${waBtn}${confirmBtn}${denyBtn}`;
  }

  function bindRowButtons(tr, lead){
    const confirm = tr.querySelector('button[data-action="confirm"]');
    const deny = tr.querySelector('button[data-action="deny"]');
    if (confirm) confirm.addEventListener("click", async () => { await labelLead(lead.id, 1); });
    if (deny) deny.addEventListener("click", async () => { await labelLead(lead.id, 0); });
  }

  function renderTable(){
    const tbody = document.getElementById("tabela");
    tbody.innerHTML = "";

    const filtered = applySearch(applyViewFilter(leads));
    if (filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" style="padding:18px; color: rgba(255,255,255,0.65);">Nenhum lead para exibir.</td></tr>`;
      return;
    }

    filtered.forEach((l, idx) => {
      const name = l.nome || "(sem nome)";
      const prob = Number(l.probabilidade);
      const band = scoreBand(prob);
      const status = statusPill(l.virou_cliente);

      const pct = fmtPct(prob);
      const p100 = Number.isFinite(prob) ? Math.round(Math.max(0, Math.min(1, prob))*100) : 0;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><div class="pill ${band.cls}">${band.label} #${idx+1}</div></td>
        <td>
          <div style="font-weight:700;">${name}</div>
          <div class="mono">${l.email_lead ? l.email_lead : ""}${l.telefone ? " ‚Ä¢ "+l.telefone : ""}</div>
        </td>
        <td>
          <div class="scoreWrap">
            <div style="min-width:44px; font-weight:800;">${pct}</div>
            <div class="bar"><div style="width:${p100}%"></div></div>
            <div class="mono">${l.tempo_site ?? "‚Äî"}s ‚Ä¢ ${l.paginas_visitadas ?? "‚Äî"} p√°g ‚Ä¢ ${l.clicou_preco ? "pre√ßo" : "sem pre√ßo"}</div>
          </div>
        </td>
        <td><span class="pill ${status.cls}">${status.label}</span></td>
        <td style="text-align:right;"><div class="actions">${renderRowActions(l)}</div></td>
      `;

      tr.addEventListener("click", (e) => {
        if (e.target && (e.target.closest("button") || e.target.closest("a"))) return;
        openDrawer(l);
      });

      tbody.appendChild(tr);
      bindRowButtons(tr, l);
    });
  }

  function renderChart(rows){
    const {hot, warm, cold} = computeKpis(rows);
    const ctx = document.getElementById("grafico");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "bar",
      data: { labels: ["üî• Quentes", "üü° Mornos", "‚ùÑÔ∏è Frios"], datasets: [{ label: "Leads (√∫ltimos 200)", data: [hot, warm, cold] }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "rgba(255,255,255,0.75)" }, grid: { color: "rgba(255,255,255,0.08)" } },
          y: { ticks: { color: "rgba(255,255,255,0.75)" }, grid: { color: "rgba(255,255,255,0.08)" }, beginAtZero: true }
        }
      }
    });
  }

  function updateHeader(summary){
    const k = computeKpis(leads);
    document.getElementById("kpiTotal").textContent = String(leads.length);
    document.getElementById("kpiHot").textContent = String(k.hot);
    document.getElementById("kpiWarm").textContent = String(k.warm);
    document.getElementById("kpiCold").textContent = String(k.cold);

    const ts = new Date();
    document.getElementById("kpiUpdated").textContent = "Atualizado: " + ts.toLocaleString();

    const c = Number(summary.convertidos || 0);
    const n = Number(summary.negados || 0);
    const p = Number(summary.pendentes || 0);
    document.getElementById("pillCounts").textContent = `convertidos: ${c} | negados: ${n} | pendentes: ${p}`;

    const th = (savedThreshold !== null && savedThreshold !== undefined) ? savedThreshold : null;
    document.getElementById("pillThreshold").textContent = `threshold: ${th !== null ? Number(th).toFixed(2) : "‚Äî"}`;

    document.getElementById("backendLabel").textContent = BACKEND;
  }

  async function carregar(){
    const clientId = document.getElementById("clientId").value.trim();
    if (!clientId){ toast("Informe um client_id."); return; }
    localStorage.setItem("leadrank_client_id", clientId);

    document.getElementById("subTitle").textContent = "Carregando‚Ä¶";
    try{
      const data = await api(`/dashboard_data?client_id=${encodeURIComponent(clientId)}`);

      const summary = {
        convertidos: data.convertidos ?? 0,
        negados: data.negados ?? 0,
        pendentes: data.pendentes ?? 0,
      };

      leads = (data.dados || []).map(l => ({
        ...l,
        probabilidade: (l.probabilidade === null || l.probabilidade === undefined) ? null : Number(l.probabilidade),
        virou_cliente: (l.virou_cliente === null || l.virou_cliente === undefined) ? -1 : Number(l.virou_cliente),
      }));

      updateHeader(summary);
      renderTable();
      renderChart(leads);

      document.getElementById("subTitle").textContent = `Mostrando ${leads.length} leads (ordenados por score).`;
      toast("Dados carregados ‚úÖ");
    }catch(err){
      document.getElementById("subTitle").textContent = "Erro ao carregar.";
      toast("Erro: " + err.message);
    }
  }

  async function labelLead(leadId, label){
    const clientId = document.getElementById("clientId").value.trim();
    if (!clientId) return toast("Informe um client_id.");
    try{
      const path = (label === 1) ? "/confirmar_venda" : "/negar_venda";
      await api(path, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({client_id: clientId, lead_id: leadId})
      });
      await carregar();
      toast(label === 1 ? "Marcado como convertido ‚úÖ" : "Marcado como negado ‚ùå");
      closeDrawer();
    }catch(err){
      toast("Erro: " + err.message);
    }
  }

  async function recalcPending(){
    const clientId = document.getElementById("clientId").value.trim();
    if (!clientId) return toast("Informe um client_id.");
    try{
      const res = await api(`/recalc_pending?client_id=${encodeURIComponent(clientId)}&limit=500`);
      toast(`Recalculado: ${res.updated || 0} leads ‚úÖ`);
      await carregar();
    }catch(err){
      toast("Erro: " + err.message);
    }
  }

  async function autoThreshold(){
    const clientId = document.getElementById("clientId").value.trim();
    if (!clientId) return toast("Informe um client_id.");
    try{
      const res = await api(`/auto_threshold`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({client_id: clientId})
      });
      savedThreshold = res.threshold;
      document.getElementById("pillThreshold").textContent = `threshold: ${Number(savedThreshold).toFixed(2)}`;
      toast(`Auto threshold definido em ${Number(savedThreshold).toFixed(2)} ‚úÖ`);
    }catch(err){
      toast("Erro: " + err.message);
    }
  }

  // Drawer actions
  document.getElementById("dConfirm").addEventListener("click", async () => { if (currentLead) await labelLead(currentLead.id, 1); });
  document.getElementById("dDeny").addEventListener("click", async () => { if (currentLead) await labelLead(currentLead.id, 0); });

  // Close drawer
  document.getElementById("btnClose").addEventListener("click", closeDrawer);
  document.getElementById("drawerOverlay").addEventListener("click", closeDrawer);
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeDrawer(); });

  // Controls
  document.getElementById("btnCarregar").addEventListener("click", carregar);
  document.getElementById("btnRecalc").addEventListener("click", recalcPending);
  document.getElementById("btnAutoTh").addEventListener("click", autoThreshold);

  document.getElementById("search").addEventListener("input", () => renderTable());
  document.getElementById("view").addEventListener("change", () => renderTable());

  document.getElementById("btnAll").addEventListener("click", () => { document.getElementById("view").value="todos"; renderTable(); });
  document.getElementById("btnPend").addEventListener("click", () => { document.getElementById("view").value="pendentes"; renderTable(); });
  document.getElementById("btnRot").addEventListener("click", () => { document.getElementById("view").value="rotulados"; renderTable(); });

  document.getElementById("btnExport").addEventListener("click", (e) => {
    e.preventDefault();
    downloadCSV(applySearch(applyViewFilter(leads)));
  });

  const saved = localStorage.getItem("leadrank_client_id");
  if (saved) document.getElementById("clientId").value = saved;
  document.getElementById("backendLabel").textContent = BACKEND;

  // Auto-load if client_id saved
  if (saved) carregar();
</script>
</body>
</html>
