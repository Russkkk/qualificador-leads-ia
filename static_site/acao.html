<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LeadRank ‚Ä¢ A√ß√£o do dia</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="page">
    <header class="site-header">
      <a class="brand" href="landing.html">
        <span class="brand__logo">LR</span>
        <span class="brand__text">LeadRank</span>
      </a>
      <nav class="site-nav">
        <a href="landing.html">In√≠cio</a>
        <a href="acao.html" aria-current="page">A√ß√£o do dia</a>
        <a href="pricing.html">Planos</a>
        <a href="onboarding.html">Criar conta</a>
        <a href="login.html">Entrar</a>
      </nav>
      <a class="btn btn--ghost" href="onboarding.html?mode=login">Trocar conta</a>
    </header>

    <main>
      <section class="dashboard">
        <div class="card daily-hero">
          <div class="daily-hero__header">
            <div>
              <p class="eyebrow">Resumo do dia</p>
              <h1 class="daily-hero__title">üî• A√ß√£o do dia</h1>
              <p class="subtitle">Esses s√£o os leads com maior chance de fechar agora.</p>
            </div>
            <div class="pill pill--muted" id="wsPill">Workspace desconectado</div>
          </div>
          <div class="daily-hero__grid">
            <div class="daily-card daily-card--hot">
              <div class="daily-card__top">
                <span class="daily-card__icon">üî•</span>
                <div>
                  <p class="daily-card__label">Quentes</p>
                  <p class="daily-card__value" id="dailyHotCount">‚Äî</p>
                </div>
              </div>
              <p class="text-muted">Ligue primeiro</p>
            </div>
            <div class="daily-card daily-card--warm">
              <div class="daily-card__top">
                <span class="daily-card__icon">üü°</span>
                <div>
                  <p class="daily-card__label">Mornos</p>
                  <p class="daily-card__value" id="dailyWarmCount">‚Äî</p>
                </div>
              </div>
              <p class="text-muted">Acompanhe hoje</p>
            </div>
            <div class="daily-card daily-card--cold">
              <div class="daily-card__top">
                <span class="daily-card__icon">‚ùÑÔ∏è</span>
                <div>
                  <p class="daily-card__label">Frios</p>
                  <p class="daily-card__value" id="dailyColdCount">‚Äî</p>
                </div>
              </div>
              <p class="text-muted">Nutrir / automa√ß√£o</p>
            </div>
            <div class="daily-card daily-card--success">
              <div class="daily-card__top">
                <span class="daily-card__icon">‚úÖ</span>
                <div>
                  <p class="daily-card__label">Convertidos hoje</p>
                  <p class="daily-card__value" id="dailyConvertedCount">‚Äî</p>
                </div>
              </div>
              <p class="text-muted">Feedback do time</p>
            </div>
          </div>
        </div>

        <div class="card action-list" data-state="loading">
          <div class="action-list__header">
            <h2>üìû Leads para agir agora</h2>
          </div>
          <div class="action-list__bar">
            <div class="chip-group" role="group" aria-label="Filtro r√°pido">
              <button class="chip chip--active" type="button" data-filter="hot" aria-pressed="true">
                üî• Quentes <span class="chip__count" data-chip-count="hot"></span>
              </button>
              <button class="chip" type="button" data-filter="warm" aria-pressed="false">
                üü° Mornos <span class="chip__count" data-chip-count="warm"></span>
              </button>
              <button class="chip" type="button" data-filter="cold" aria-pressed="false">
                ‚ùÑÔ∏è Frios <span class="chip__count" data-chip-count="cold"></span>
              </button>
              <button class="chip" type="button" data-filter="pendente" aria-pressed="false">
                ‚è≥ Pendentes <span class="chip__count" data-chip-count="pendente"></span>
              </button>
              <button class="chip" type="button" data-filter="convertido" aria-pressed="false">
                ‚úÖ Convertidos <span class="chip__count" data-chip-count="convertido"></span>
              </button>
              <button class="chip" type="button" data-filter="negado" aria-pressed="false">
                ‚ùå Negados <span class="chip__count" data-chip-count="negado"></span>
              </button>
            </div>
            <div class="action-list__controls">
              <label class="search">
                <span class="sr-only">Buscar por nome, telefone, origem</span>
                <input type="search" id="leadSearch" placeholder="Buscar por nome, telefone, origem" />
              </label>
              <button class="btn btn--ghost btn--small" type="button" id="btnExport">Exportar CSV</button>
            </div>
          </div>
          <div class="action-list__body">
            <div class="action-state action-state--loading">
              <p class="text-muted">Atualizando a lista de leads com maior prioridade...</p>
              <div class="skeleton-grid">
                <div class="skeleton-card">
                  <div class="skeleton-line skeleton-line--lg"></div>
                  <div class="skeleton-line"></div>
                  <div class="skeleton-pill"></div>
                </div>
                <div class="skeleton-card">
                  <div class="skeleton-line skeleton-line--lg"></div>
                  <div class="skeleton-line"></div>
                  <div class="skeleton-pill"></div>
                </div>
              </div>
              <div class="skeleton-table">
                <div class="skeleton-line skeleton-line--md"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
              </div>
            </div>
            <div class="action-state action-state--empty">
              <div class="empty-state">
                <p class="empty-state__title">Voc√™ ainda n√£o tem leads suficientes para priorizar.</p>
                <p class="text-muted">Gere leads de teste ou conecte seu CRM para ver recomenda√ß√µes di√°rias automaticamente.</p>
                <div class="action-list__cta">
                  <button class="btn btn--small" type="button" data-seed10>Gerar 10 leads de teste</button>
                  <a class="btn btn--ghost btn--small" href="onboarding.html#integracao" target="_blank" rel="noreferrer">Ver como integrar</a>
                </div>
              </div>
            </div>
            <div class="action-state action-state--error">
              <div class="error-state">
                <p class="empty-state__title">N√£o conseguimos carregar seus leads agora.</p>
                <p class="text-muted">Verifique sua conex√£o e tente novamente em instantes.</p>
                <button class="btn btn--small" type="button" id="btnRetry">Tentar novamente</button>
              </div>
            </div>
            <div class="action-state action-state--ready">
              <div class="action-list__insights">
                <p>Leads quentes = maiores chances de fechar agora.</p>
                <p>Marque o resultado do contato. O LeadRank aprende com seu time.</p>
                <p>Quanto mais feedback, melhor a prioriza√ß√£o.</p>
              </div>
              <div class="action-list__table" id="leadsTableWrap"></div>
            </div>
          </div>
          <div class="alert" id="actionMsg"></div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <span>¬© 2024 LeadRank. Todos os direitos reservados.</span>
      <div class="footer__links">
        <a href="landing.html">In√≠cio</a>
        <a href="pricing.html">Planos</a>
        <a href="onboarding.html">Criar conta</a>
      </div>
    </footer>
  </div>

  <script>
    const BACKEND = (window.BACKEND_URL || "https://qualificador-leads-i-a.onrender.com").replace(/\/$/, "");

    const el = (id) => document.getElementById(id);
    const msg = el("actionMsg");
    const wsPill = el("wsPill");
    const leadsTableWrap = el("leadsTableWrap");
    const searchInput = el("leadSearch");
    const chips = Array.from(document.querySelectorAll("[data-filter]"));
    const chipCounts = Array.from(document.querySelectorAll("[data-chip-count]"));
    const actionList = document.querySelector(".action-list");
    let allItems = [];

    let summaryState = { hot: 0, warm: 0, cold: 0, converted_today: 0 };

    let activeFilter = "hot";

    function setMsg(type, text) {
      msg.className = "alert" + (type ? " " + type : "");
      msg.style.display = "block";
      msg.textContent = text;
    }

    function setActionState(state) {
      if (!actionList) return;
      actionList.dataset.state = state;
    }

    function normalizeTempLabel(temp) {
      if (!temp) return "unknown";
      const value = temp.toString().toLowerCase();
      if (value.startsWith("hot") || value.startsWith("quente")) return "hot";
      if (value.startsWith("warm") || value.startsWith("morno")) return "warm";
      if (value.startsWith("cold") || value.startsWith("frio")) return "cold";
      return "unknown";
    }

    function updateChipCounts(items) {
      const counts = {
        hot: 0,
        warm: 0,
        cold: 0,
        pendente: 0,
        convertido: 0,
        negado: 0,
      };
      items.forEach((item) => {
        const temp = normalizeTempLabel(item.temperatura);
        if (counts[temp] != null) counts[temp] += 1;
        const status = (item.status || "pendente").toString().toLowerCase();
        if (counts[status] != null) counts[status] += 1;
      });
      chipCounts.forEach((el) => {
        const key = el.dataset.chipCount;
        if (!key) return;
        const value = counts[key];
        el.textContent = typeof value === "number" ? `(${value})` : "";
      });
    }

    function qs(name) {
      return new URLSearchParams(location.search).get(name) || "";
    }

    function getAuth() {
      return {
        client_id: qs("client_id") || localStorage.getItem("leadrank_client_id") || localStorage.getItem("client_id") || localStorage.getItem("LR_CLIENT_ID") || "",
        api_key: qs("api_key") || localStorage.getItem("leadrank_api_key") || localStorage.getItem("api_key") || localStorage.getItem("LR_API_KEY") || "",
      };
    }

    async function api(path) {
      const { client_id, api_key } = getAuth();
      const url = new URL(BACKEND + path);
      url.searchParams.set("client_id", client_id);
      const headers = {};
      if (api_key) headers["X-API-KEY"] = api_key;
      const res = await fetch(url.toString(), { headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || data.message || ("HTTP " + res.status));
      return data;
    }

    async function apiPost(path, body) {
      const { api_key } = getAuth();
      const headers = { "Content-Type": "application/json" };
      if (api_key) headers["X-API-KEY"] = api_key;
      const res = await fetch(BACKEND + path, {
        method: "POST",
        headers,
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || data.message || ("HTTP " + res.status));
      return data;
    }

    async function seedTestLeads() {
      const { client_id, api_key } = getAuth();
      if (!client_id || !api_key) {
        setMsg("alert--error", "Conecte seu workspace para gerar leads de teste.");
        return;
      }
      try {
        await fetch(BACKEND + "/seed_test_leads", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-KEY": api_key,
          },
          body: JSON.stringify({ client_id, n: 10 }),
        });
        setMsg("alert--success", "Leads de teste gerados. Atualizando a lista...");
        await loadAction();
      } catch (err) {
        setMsg("alert--error", "N√£o foi poss√≠vel gerar leads de teste agora.");
      }
    }

    function renderHero(summary) {
      el("dailyHotCount").textContent = summary.hot ?? 0;
      el("dailyWarmCount").textContent = summary.warm ?? 0;
      el("dailyColdCount").textContent = summary.cold ?? 0;
      el("dailyConvertedCount").textContent = summary.converted_today ?? 0;
    }

    function normalizeText(value) {
      return (value || "").toString().toLowerCase();
    }

    function applyFilters() {
      const term = normalizeText(searchInput.value);
      const filtered = allItems.filter((item) => {
        const temperature = item.temperatura || "unknown";
        const status = item.status || "pendente";
        const matchesFilter = ["hot", "warm", "cold"].includes(activeFilter)
          ? temperature === activeFilter
          : status === activeFilter;
        if (!matchesFilter) return false;
        if (!term) return true;
        return [item.nome, item.telefone, item.origem].some((field) => normalizeText(field).includes(term));
      });
      renderTable(filtered);
    }

    function renderTable(items) {
      if (!items.length) {
        leadsTableWrap.innerHTML = "<div class='text-muted'>Nenhum lead encontrado com os filtros atuais.</div>";
        return;
      }
      const rows = items.map((item) => {
        const temperature = normalizeTempLabel(item.temperatura);
        const tempLabel = temperature === "hot" ? "üî• Quente" : temperature === "warm" ? "üü° Morno" : temperature === "cold" ? "‚ùÑÔ∏è Frio" : "‚Äî";
        const prob = item.probabilidade != null ? Math.round(item.probabilidade * 100) + "%" : "‚Äî";
        const score = item.score != null ? item.score : "‚Äî";
        return `
          <tr>
            <td data-label="Lead">
              <div class="lead-cell">
                <p class="lead-cell__name">${item.nome || "Lead sem nome"}</p>
                <p class="lead-cell__meta text-muted">${item.telefone || "Sem telefone"} ‚Ä¢ ${item.email_lead || "Sem email"}</p>
              </div>
            </td>
            <td data-label="Origem">
              <span class="pill pill--muted">${item.origem || "‚Äî"}</span>
            </td>
            <td data-label="Temperatura">
              <span class="pill pill--muted">${tempLabel}</span>
            </td>
            <td data-label="Score/Prob">
              <div class="table-metric">
                <strong>${score}</strong>
                <span class="text-muted">${prob}</span>
              </div>
            </td>
            <td data-label="Criado em">${item.created_at ? new Date(item.created_at).toLocaleDateString("pt-BR") : "‚Äî"}</td>
            <td data-label="A√ß√µes">
              <div class="button-group">
                <button class="btn btn--tiny" type="button" data-action="convert" data-id="${item.id}" aria-label="Marcar ${item.nome || "lead"} como virou cliente">‚úÖ Virou</button>
                <button class="btn btn--tiny btn--ghost" type="button" data-action="deny" data-id="${item.id}" aria-label="Marcar ${item.nome || "lead"} como n√£o virou">‚ùå N√£o virou</button>
                <button class="btn btn--tiny btn--ghost" type="button" data-action="later" data-id="${item.id}" aria-label="Lembrar depois do lead ${item.nome || "sem nome"}">‚è≥ Depois</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      leadsTableWrap.innerHTML = `
        <table class="data-table leads-table">
          <thead>
            <tr>
              <th>Lead</th>
              <th>Origem</th>
              <th>Temperatura</th>
              <th>Score/Prob</th>
              <th>Criado</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function setActiveChip(filter) {
      activeFilter = filter;
      chips.forEach((chip) => {
        chip.classList.toggle("chip--active", chip.dataset.filter === filter);
        chip.setAttribute("aria-pressed", chip.dataset.filter === filter ? "true" : "false");
      });
      applyFilters();
    }

    chips.forEach((chip) => {
      chip.addEventListener("click", () => setActiveChip(chip.dataset.filter));
      chip.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          chip.click();
        }
      });
    });

    searchInput.addEventListener("input", () => applyFilters());

    el("btnRetry").onclick = () => loadAction();

    el("btnExport").onclick = () => {
      const { client_id, api_key } = getAuth();
      if (!client_id) return setMsg("alert--error", "Informe seu workspace para exportar.");
      const url = new URL(BACKEND + "/leads_export.csv");
      url.searchParams.set("client_id", client_id);
      if (api_key) {
        setMsg("alert--error", "Para exportar com API Key, fa√ßa o download via API ou desative a exig√™ncia.");
        return;
      }
      window.location.href = url.toString();
    };

    const seedBtn = document.querySelector("[data-seed10]");
    if (seedBtn) {
      seedBtn.addEventListener("click", seedTestLeads);
    }

    async function loadAction() {
      msg.style.display = "none";
      setActionState("loading");
      const { client_id } = getAuth();
      wsPill.textContent = client_id ? "Workspace conectado" : "Workspace desconectado";
      if (!client_id) {
        setActionState("error");
        setMsg("alert--error", "Informe seu workspace para carregar.");
        return;
      }
      try {
        const data = await api("/acao_do_dia");

        summaryState = {
          hot: data.summary?.hot ?? 0,
          warm: data.summary?.warm ?? 0,
          cold: data.summary?.cold ?? 0,
          converted_today: data.summary?.converted_today ?? 0,
        };
        renderHero(summaryState);

        renderHero(data.summary || {});

        allItems = data.items || [];
        updateChipCounts(allItems);
        if (!allItems.length) {
          setActionState("empty");
        } else {
          setActionState("ready");
          setActiveChip(activeFilter);
        }
        setMsg("alert--success", "A√ß√£o do dia carregada.");
      } catch (err) {
        setActionState("error");
        setMsg("alert--error", "N√£o conseguimos carregar seus leads. Confira sua conex√£o ou chave de integra√ß√£o.");
      }
    }

    leadsTableWrap.addEventListener("click", async (event) => {
      const button = event.target.closest("[data-action]");
      if (!button) return;
      const action = button.dataset.action;
      const leadId = Number(button.dataset.id || 0);
      const { client_id } = getAuth();
      if (!leadId || !client_id) return;

      try {
        if (action === "convert") {
          await apiPost("/confirmar_venda", { client_id, lead_id: leadId });
          summaryState.converted_today += 1;
          renderHero(summaryState);
          allItems = allItems.map((item) =>
            item.id === leadId ? { ...item, status: "convertido" } : item
          );
        } else if (action === "deny") {
          await apiPost("/negar_venda", { client_id, lead_id: leadId });
          allItems = allItems.map((item) =>
            item.id === leadId ? { ...item, status: "negado" } : item
          );
        } else if (action === "later") {
          allItems = allItems.filter((item) => item.id !== leadId);
        }
        updateChipCounts(allItems);
        applyFilters();
      } catch (err) {
        setMsg("alert--error", "N√£o foi poss√≠vel atualizar o lead. Tente novamente.");
      }
    });

    loadAction();
  </script>
</body>
</html>
