<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LeadRank - Qualificador de Leads com IA</title>
  <meta name="description" content="Priorize leads quentes automaticamente e aumente suas vendas. Teste grátis 14 dias.">
  <meta property="og:title" content="LeadRank - Qualificador de Leads com IA">
  <meta property="og:description" content="Priorize leads quentes automaticamente e aumente suas vendas. Teste grátis 14 dias.">
  <meta property="og:image" content="assets/og-image.svg">
  <meta property="og:url" content="https://leadrank.com.br/">
  <meta name="theme-color" content="#4f7cff">
  <link rel="icon" href="assets/favicon.svg">
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-active-nav="acao">
  <template id="header-actions-template">
    <button class="btn btn--ghost btn--small" type="button" id="restartDemoBtn">Reiniciar demo</button>
    <a class="btn btn--ghost" href="onboarding.html?mode=login">Trocar conta</a>
  </template>
  <div class="page">
    <div data-include="site-header"></div>

    <main>
      <div id="acao-app"></div>
    </main>

    <div data-include="site-footer"></div>
  </div>
  <script src="partials/site-shell.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const BACKEND = (window.BACKEND_URL || "https://qualificador-leads-ia.onrender.com").replace(/\/$/, "");

    const el = (id) => document.getElementById(id);
    const msg = el("actionMsg");
    const wsPill = el("wsPill");
    const leadsTableWrap = el("leadsTableWrap");
    const searchInput = el("leadSearch");
    const chips = Array.from(document.querySelectorAll("[data-filter]"));
    const chipCounts = Array.from(document.querySelectorAll("[data-chip-count]"));
    const actionList = document.querySelector(".action-list");
    const upgradeBanner = el("upgradeBanner");
    const accuracyText = el("accuracyText");
    const accuracyChartEl = el("accuracyChart");
    const recalcBtn = el("recalcBtn");
    const recalcMsg = el("recalcMsg");
    let allItems = [];
    let accuracyChart = null;
    const ICONS = {
      check: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6 9 17l-5-5"/></svg>`,
      x: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12"/></svg>`,
      clock: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>`,
      flame: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 17a2 2 0 0 0 2-2c0-1.53-1.5-2.6-1.5-4A2.5 2.5 0 0 1 14 8.5c0-3-2.5-5.5-6-6 1 1.5 1 4.5-1 6-1.5 1.1-3 2.6-3 5a6 6 0 0 0 6 6 6 6 0 0 0 6-6c0-1.8-.4-2.8-1.6-4.4 0 1.5-1 2.5-2.4 3.4-1.2.8-2.5 1.8-2.5 3.5"/></svg>`,
      thermometer: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a2 2 0 0 0-2 2v10a4 4 0 1 0 4 0V4a2 2 0 0 0-2-2z"/></svg>`,
      snow: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2v20"/><path d="M5.5 5.5l13 13"/><path d="M5.5 18.5l13-13"/></svg>`,
      alert: `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
    };

    let summaryState = { hot: 0, warm: 0, cold: 0, converted_today: 0 };

    let activeFilter = "hot";

    function setMsg(type, text) {
      msg.className = "alert" + (type ? " " + type : "");
      msg.style.display = "block";
      msg.textContent = text;
    }

    function setActionState(state) {
      if (!actionList) return;
      actionList.dataset.state = state;
    }

    function normalizeTempLabel(temp) {
      if (!temp) return "unknown";
      const value = temp.toString().toLowerCase();
      if (value.startsWith("hot") || value.startsWith("quente")) return "hot";
      if (value.startsWith("warm") || value.startsWith("morno")) return "warm";
      if (value.startsWith("cold") || value.startsWith("frio")) return "cold";
      return "unknown";
    }

    function updateChipCounts(items) {
      const counts = {
        hot: 0,
        warm: 0,
        cold: 0,
        pendente: 0,
        convertido: 0,
        negado: 0,
      };
      items.forEach((item) => {
        const temp = normalizeTempLabel(item.temperatura);
        if (counts[temp] != null) counts[temp] += 1;
        const status = (item.status || "pendente").toString().toLowerCase();
        if (counts[status] != null) counts[status] += 1;
      });
      chipCounts.forEach((el) => {
        const key = el.dataset.chipCount;
        if (!key) return;
        const value = counts[key];
        el.textContent = typeof value === "number" ? `(${value})` : "";
      });
    }

    function getAuth() {
      const clientId =
        localStorage.getItem("leadrank_client_id") ||
        localStorage.getItem("client_id") ||
        localStorage.getItem("LR_CLIENT_ID") ||
        "";
      const apiKey =
        localStorage.getItem("leadrank_api_key") ||
        localStorage.getItem("api_key") ||
        localStorage.getItem("LR_API_KEY") ||
        "";
      return {
        client_id: clientId.trim(),
        api_key: apiKey.trim(),
      };
    }

    async function api(path) {
      const { client_id, api_key } = getAuth();
      const headers = {};
      if (client_id) headers["X-CLIENT-ID"] = client_id;
      if (api_key) headers["X-API-KEY"] = api_key;
      const res = await fetch(BACKEND + path, { headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || data.message || ("HTTP " + res.status));
      return data;
    }

    async function apiPost(path, body) {
      const { api_key, client_id } = getAuth();
      const headers = {
        "Content-Type": "application/json",
      };
      if (client_id) headers["X-CLIENT-ID"] = client_id;
      if (api_key) headers["X-API-KEY"] = api_key;
      const res = await fetch(BACKEND + path, {
        method: "POST",
        headers,
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || data.message || ("HTTP " + res.status));
      return data;
    }

    function formatPercent(value) {
      if (value == null || Number.isNaN(value)) return "—";
      const pct = value > 1 ? value : value * 100;
      return `${pct.toFixed(1)}%`;
    }

    function normalizeBuckets(data) {
      const buckets = data?.buckets || data?.probability_buckets || data?.faixas || data?.conversion_by_bucket;
      if (Array.isArray(buckets)) {
        return buckets.map((bucket) => ({
          label: bucket.label || bucket.range || bucket.faixa || "—",
          value: Number(bucket.value ?? bucket.rate ?? bucket.conversion ?? 0),
        }));
      }
      if (buckets && typeof buckets === "object") {
        return Object.entries(buckets).map(([label, value]) => ({
          label,
          value: Number(value || 0),
        }));
      }
      return [
        { label: "0-30%", value: 0.12 },
        { label: "31-60%", value: 0.28 },
        { label: "61-80%", value: 0.52 },
        { label: "81-100%", value: 0.74 },
      ];
    }

    function renderAccuracyChart(buckets) {
      if (!accuracyChartEl) return;
      const labels = buckets.map((bucket) => bucket.label);
      const values = buckets.map((bucket) => Math.round((bucket.value || 0) * 100));

      if (accuracyChart) accuracyChart.destroy();
      if (!window.Chart) return;

      accuracyChart = new Chart(accuracyChartEl, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Conversão (%)",
              data: values,
              backgroundColor: "rgba(79, 124, 255, 0.5)",
              borderRadius: 8,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (value) => `${value}%` },
            },
          },
          plugins: {
            legend: { display: false },
          },
        },
      });
    }

    async function loadInsights() {
      const { client_id } = getAuth();
      if (!client_id) return;
      try {
        let data = null;
        try {
          data = await api("/insights");
        } catch (err) {
          data = await apiPost("/auto_threshold", { client_id });
        }
        const hotAccuracy =
          data?.hot_accuracy ??
          data?.accuracy_hot ??
          data?.summary?.hot_accuracy ??
          data?.summary?.hot_conversion ??
          data?.precision_hot ??
          0;
        if (accuracyText) {
          accuracyText.textContent = `Nos últimos 30 dias acertamos ${formatPercent(hotAccuracy)} dos leads marcados como quentes.`;
        }
        const buckets = normalizeBuckets(data);
        renderAccuracyChart(buckets);
      } catch (err) {
        if (accuracyText) {
          accuracyText.textContent = "Não foi possível carregar o relatório de precisão agora.";
        }
      }
    }

    async function seedTestLeads() {
      const { client_id, api_key } = getAuth();
      if (!client_id || !api_key) {
        setMsg("alert--error", "Conecte seu workspace para gerar leads de teste.");
        return;
      }
      try {
        await fetch(BACKEND + "/seed_test_leads", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-KEY": api_key,
            "X-CLIENT-ID": client_id,
          },
          body: JSON.stringify({ client_id, n: 10 }),
        });
        setMsg("alert--success", "Leads de teste gerados. Atualizando a lista...");
        await loadAction();
      } catch (err) {
        setMsg("alert--error", "Não foi possível gerar leads de teste agora.");
      }
    }

    function renderHero(summary) {
      el("dailyHotCount").textContent = summary.hot ?? 0;
      el("dailyWarmCount").textContent = summary.warm ?? 0;
      el("dailyColdCount").textContent = summary.cold ?? 0;
      el("dailyConvertedCount").textContent = summary.converted_today ?? 0;
    }

    function shouldShowUpgradeBanner() {
      const dismissedAt = Number(localStorage.getItem("leadrank_upgrade_banner_dismissed_at") || 0);
      if (!dismissedAt) return true;
      const hoursSince = (Date.now() - dismissedAt) / (1000 * 60 * 60);
      return hoursSince >= 24;
    }

    function dismissUpgradeBanner() {
      localStorage.setItem("leadrank_upgrade_banner_dismissed_at", String(Date.now()));
      if (upgradeBanner) upgradeBanner.style.display = "none";
    }

    function updateUpgradeBanner(summary) {
      if (!upgradeBanner) return;
      const used = Number(summary?.leads_used_month ?? 0);
      const limit = Number(summary?.lead_limit_month ?? 0);
      if (!limit || !used || !shouldShowUpgradeBanner()) {
        upgradeBanner.style.display = "none";
        return;
      }
      const usagePercent = (used / limit) * 100;
      let variant = null;
      if (usagePercent >= 90) {
        variant = {
          className: "alert--danger",
          text: `${ICONS.alert} Você está a um passo de pausar novos leads. Faça upgrade para não perder oportunidades.`,
          primary: { label: "Upgrade imediato", href: "pricing.html" },
          secondary: { label: "Falar com suporte", href: "mailto:suporte@leadrank.com" },
        };
      } else if (usagePercent >= 70) {
        variant = {
          className: "alert--warning",
          text: `${ICONS.alert} Sua Ação do Dia pode começar a ficar incompleta. Quer manter a lista diária sempre cheia?`,
          primary: { label: "Fazer upgrade agora", href: "pricing.html" },
          secondary: { label: "Ver capacidade", href: "pricing.html#capacity" },
        };
      }
      if (!variant) {
        upgradeBanner.style.display = "none";
        return;
      }
      upgradeBanner.className = `alert upgrade-banner ${variant.className}`;
      upgradeBanner.innerHTML = `
        <div>
          <strong>Capacidade em uso: ${Math.round(usagePercent)}%</strong>
          <p class="icon-button">${variant.text}</p>
          <div class="upgrade-banner__actions">
            <a class="btn btn--small" href="${variant.primary.href}">${variant.primary.label}</a>
            <a class="btn btn--ghost btn--small" href="${variant.secondary.href}">${variant.secondary.label}</a>
          </div>
        </div>
        <button class="upgrade-banner__close" type="button" aria-label="Fechar aviso">×</button>
      `;
      upgradeBanner.style.display = "flex";
      const closeBtn = upgradeBanner.querySelector(".upgrade-banner__close");
      if (closeBtn) {
        closeBtn.addEventListener("click", dismissUpgradeBanner);
      }
    }

    function normalizeText(value) {
      return (value || "").toString().toLowerCase();
    }

    function applyFilters() {
      const term = normalizeText(searchInput.value);
      const filtered = allItems.filter((item) => {
        const temperature = item.temperatura || "unknown";
        const status = item.status || "pendente";
        const matchesFilter = ["hot", "warm", "cold"].includes(activeFilter)
          ? temperature === activeFilter
          : status === activeFilter;
        if (!matchesFilter) return false;
        if (!term) return true;
        return [item.nome, item.telefone, item.origem].some((field) => normalizeText(field).includes(term));
      });
      renderTable(filtered);
    }

    function renderTable(items) {
      if (!items.length) {
        leadsTableWrap.innerHTML = "<div class='text-muted'>Nenhum lead encontrado com os filtros atuais.</div>";
        return;
      }
      const rows = items.map((item) => {
        const temperature = normalizeTempLabel(item.temperatura);
        const tempLabel =
          temperature === "hot"
            ? `${ICONS.flame} Quente`
            : temperature === "warm"
              ? `${ICONS.thermometer} Morno`
              : temperature === "cold"
                ? `${ICONS.snow} Frio`
                : "—";
        const prob = item.probabilidade != null ? Math.round(item.probabilidade * 100) + "%" : "—";
        const score = item.score != null ? item.score : "—";
        return `
          <tr class="lead-row">
            <td data-label="Lead">
              <div class="lead-cell">
                <p class="lead-cell__name">${item.nome || "Lead sem nome"}</p>
                <p class="lead-cell__meta text-muted">${item.telefone || "Sem telefone"} • ${item.email_lead || "Sem email"}</p>
              </div>
            </td>
            <td data-label="Origem">
              <span class="pill pill--muted">${item.origem || "—"}</span>
            </td>
            <td data-label="Temperatura">
              <span class="pill pill--muted icon-button">${tempLabel}</span>
            </td>
            <td data-label="Score/Prob">
              <div class="table-metric">
                <strong>${score}</strong>
                <span class="text-muted">${prob}</span>
              </div>
            </td>
            <td data-label="Criado em">${item.created_at ? new Date(item.created_at).toLocaleDateString("pt-BR") : "—"}</td>
            <td data-label="Ações">
              <div class="button-group lead-actions">
                <button class="btn btn--tiny icon-button" type="button" data-action="convert" data-id="${item.id}" aria-label="Marcar ${item.nome || "lead"} como virou cliente">${ICONS.check} Virou</button>
                <button class="btn btn--tiny btn--ghost icon-button" type="button" data-action="deny" data-id="${item.id}" aria-label="Marcar ${item.nome || "lead"} como não virou">${ICONS.x} Não virou</button>
                <button class="btn btn--tiny btn--ghost icon-button" type="button" data-action="later" data-id="${item.id}" aria-label="Lembrar depois do lead ${item.nome || "sem nome"}">${ICONS.clock} Depois</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      leadsTableWrap.innerHTML = `
        <table class="data-table leads-table">
          <thead>
            <tr>
              <th>Lead</th>
              <th>Origem</th>
              <th>Temperatura</th>
              <th>Score/Prob</th>
              <th>Criado</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function setActiveChip(filter) {
      activeFilter = filter;
      chips.forEach((chip) => {
        chip.classList.toggle("chip--active", chip.dataset.filter === filter);
        chip.setAttribute("aria-pressed", chip.dataset.filter === filter ? "true" : "false");
      });
      applyFilters();
    }

    chips.forEach((chip) => {
      chip.addEventListener("click", () => setActiveChip(chip.dataset.filter));
      chip.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          chip.click();
        }
      });
    });

    searchInput.addEventListener("input", () => applyFilters());

    el("btnRetry").onclick = () => loadAction();

    el("btnExport").onclick = () => {
      const { client_id, api_key } = getAuth();
      if (!client_id || !api_key) {
        return setMsg("alert--error", "Conecte seu workspace com sua chave para exportar.");
      }
      fetch(BACKEND + "/leads_export.csv", {
        headers: {
          "X-CLIENT-ID": client_id,
          "X-API-KEY": api_key,
        },
      })
        .then((resp) => {
          if (!resp.ok) throw new Error("Falha ao exportar");
          const disposition = resp.headers.get("Content-Disposition") || "";
          const match = /filename="([^"]+)"/i.exec(disposition);
          const filename = match?.[1] || `leadrank_${client_id}.csv`;
          return resp.blob().then((blob) => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
        })
        .catch(() => {
          setMsg("alert--error", "Não foi possível exportar agora.");
        });
    };

    const seedBtn = document.querySelector("[data-seed10]");
    if (seedBtn) {
      seedBtn.addEventListener("click", seedTestLeads);
    }

    if (recalcBtn) {
      recalcBtn.addEventListener("click", async () => {
        const { client_id } = getAuth();
        if (!client_id) {
          recalcMsg.className = "alert alert--error";
          recalcMsg.textContent = "Conecte seu workspace para recalcular.";
          recalcMsg.style.display = "block";
          return;
        }
        recalcMsg.style.display = "none";
        try {
          await apiPost("/recalc_pending", { client_id });
          recalcMsg.className = "alert alert--success";
          recalcMsg.textContent = "Recalculo iniciado! Atualizando dados...";
          recalcMsg.style.display = "block";
          await loadAction();
          await loadInsights();
        } catch (err) {
          recalcMsg.className = "alert alert--error";
          recalcMsg.textContent = "Não foi possível recalcular agora.";
          recalcMsg.style.display = "block";
        }
      });
    }

    async function loadAction() {
      msg.style.display = "none";
      setActionState("loading");
      const { client_id } = getAuth();
      wsPill.textContent = client_id ? "Workspace conectado" : "Workspace desconectado";
      if (!client_id) {
        setActionState("error");
        setMsg("alert--error", "Informe seu workspace para carregar.");
        return;
      }
      try {
        const data = await api("/acao_do_dia");

        summaryState = {
          hot: data.summary?.hot ?? 0,
          warm: data.summary?.warm ?? 0,
          cold: data.summary?.cold ?? 0,
          converted_today: data.summary?.converted_today ?? 0,
        };
        renderHero(summaryState);
        updateUpgradeBanner(summaryState);

        renderHero(data.summary || {});

        allItems = data.items || [];
        updateChipCounts(allItems);
        if (!allItems.length) {
          setActionState("empty");
        } else {
          setActionState("ready");
          setActiveChip(activeFilter);
        }
        setMsg("alert--success", "Ação do dia carregada.");
      } catch (err) {
        setActionState("error");
        setMsg("alert--error", "Não conseguimos carregar seus leads. Confira sua conexão ou chave de integração.");
      }
    }

    leadsTableWrap.addEventListener("click", async (event) => {
      const button = event.target.closest("[data-action]");
      if (!button) return;
      const action = button.dataset.action;
      const leadId = Number(button.dataset.id || 0);
      const { client_id } = getAuth();
      if (!leadId || !client_id) return;

      try {
        if (action === "convert") {
          await apiPost("/confirmar_venda", { client_id, lead_id: leadId });
          summaryState.converted_today += 1;
          renderHero(summaryState);
          allItems = allItems.map((item) =>
            item.id === leadId ? { ...item, status: "convertido" } : item
          );
        } else if (action === "deny") {
          await apiPost("/negar_venda", { client_id, lead_id: leadId });
          allItems = allItems.map((item) =>
            item.id === leadId ? { ...item, status: "negado" } : item
          );
        } else if (action === "later") {
          allItems = allItems.filter((item) => item.id !== leadId);
        }
        updateChipCounts(allItems);
        applyFilters();
      } catch (err) {
        setMsg("alert--error", "Não foi possível atualizar o lead. Tente novamente.");
      }
    });

    loadAction();
    loadInsights();

    const DEMO_KEY = "leadrank_demo_completed";
    const resolveRestartBtn = () => document.getElementById("restartDemoBtn");
    const demoState = {
      active: false,
      current: 0,
      actionDone: false,
      overlay: null,
      highlight: null,
      tooltip: null,
      progress: null,
      title: null,
      body: null,
      helper: null,
      btnPrev: null,
      btnNext: null,
      btnSkip: null,
      btnFinish: null,
      demoLeadInserted: false,
      prevActionState: null,
    };

    const steps = [
      {
        id: "daily-hot",
        title: "Ação do Dia",
        text: "Aqui estão os leads com maior chance de fechar agora. Comece por eles.",
        target: () => document.getElementById("kpiHot"),
      },
      {
        id: "lead-list",
        title: "Lista de prioridades",
        text: "Esta é sua fila do dia. Comece sempre pelos primeiros.",
        target: () => document.getElementById("leadsSection"),
      },
      {
        id: "lead-actions",
        title: "Marque o resultado em 1 clique",
        text: "Depois do contato, marque Virou ou Não virou. Isso melhora a priorização automaticamente.",
        requireAction: true,
        target: () => document.querySelector(".lead-actions"),
        fallback: () => document.querySelector(".demo-lead-actions"),
      },
      {
        id: "daily-ritual",
        title: "Rotina diária simples",
        text: "Amanhã a lista é recalculada. Quanto mais você marca resultados, melhor fica.",
        target: () => document.querySelector(".daily-hero"),
      },
      {
        id: "integration",
        title: "Use com seus leads reais",
        text: "Conecte formulário, tráfego pago, WhatsApp ou CRM e deixe a lista pronta todo dia.",
        target: () => document.getElementById("integrationLink"),
      },
      {
        id: "finish",
        title: "Pronto. Agora é só seguir a lista.",
        text: "Menos dúvida. Mais foco. Mais vendas.",
        target: () => null,
        isFinal: true,
      },
    ];

    function buildTourUI() {
      if (demoState.overlay) return;
      const overlay = document.createElement("div");
      overlay.className = "tour-overlay";
      overlay.innerHTML = `<div class="tour-highlight" role="presentation"></div>`;
      document.body.appendChild(overlay);
      const tooltip = document.createElement("div");
      tooltip.className = "tour-tooltip";
      tooltip.setAttribute("role", "dialog");
      tooltip.setAttribute("aria-live", "polite");
      tooltip.style.display = "none";
      tooltip.innerHTML = `
        <div class="tour-progress"></div>
        <h3 class="tour-title"></h3>
        <p class="tour-text"></p>
        <p class="tour-helper"></p>
        <div class="tour-actions">
          <button class="btn btn--ghost btn--small" type="button" data-tour-prev>Voltar</button>
          <button class="btn btn--small" type="button" data-tour-next>Próximo</button>
          <button class="btn btn--ghost btn--small" type="button" data-tour-skip>Pular demo</button>
        </div>
        <div class="tour-actions tour-actions--final">
          <button class="btn btn--small" type="button" data-tour-finish>Continuar</button>
          <a class="btn btn--ghost btn--small" href="pricing.html">Ver planos</a>
        </div>
      `;
      document.body.appendChild(tooltip);
      demoState.overlay = overlay;
      demoState.highlight = overlay.querySelector(".tour-highlight");
      demoState.tooltip = tooltip;
      demoState.progress = tooltip.querySelector(".tour-progress");
      demoState.title = tooltip.querySelector(".tour-title");
      demoState.body = tooltip.querySelector(".tour-text");
      demoState.helper = tooltip.querySelector(".tour-helper");
      demoState.btnPrev = tooltip.querySelector("[data-tour-prev]");
      demoState.btnNext = tooltip.querySelector("[data-tour-next]");
      demoState.btnSkip = tooltip.querySelector("[data-tour-skip]");
      demoState.btnFinish = tooltip.querySelector("[data-tour-finish]");

      demoState.btnPrev.addEventListener("click", prevStep);
      demoState.btnNext.addEventListener("click", nextStep);
      demoState.btnSkip.addEventListener("click", () => endDemo(false));
      demoState.btnFinish.addEventListener("click", () => endDemo(true));

      document.addEventListener("keydown", (event) => {
        if (!demoState.active) return;
        if (event.key === "Escape") {
          endDemo(false);
        }
      });
    }

    function ensureDemoLeadRow() {
      if (document.querySelector(".lead-row")) return;
      if (Array.isArray(allItems) && allItems.length) {
        if (searchInput) searchInput.value = "";
        if (chips.length) {
          const nextFilter =
            allItems.some((item) => normalizeTempLabel(item.temperatura) === "hot")
              ? "hot"
              : allItems.some((item) => normalizeTempLabel(item.temperatura) === "warm")
                ? "warm"
                : allItems.some((item) => normalizeTempLabel(item.temperatura) === "cold")
                  ? "cold"
                  : "pendente";
          setActiveChip(nextFilter);
        } else {
          renderTable(allItems);
        }
        if (document.querySelector(".lead-row")) return;
      }
      demoState.prevActionState = actionList?.dataset.state || "loading";
      setActionState("ready");
      const demoRow = document.createElement("div");
      demoRow.className = "demo-lead-row lead-row";
      demoRow.innerHTML = `
        <div class="demo-lead-info">
          <strong>Lead de teste</strong>
          <span class="text-muted">WhatsApp • agora</span>
        </div>
        <div class="lead-actions demo-lead-actions">
          <button class="btn btn--tiny icon-button" type="button" data-action="convert">${ICONS.check} Virou</button>
          <button class="btn btn--tiny btn--ghost icon-button" type="button" data-action="deny">${ICONS.x} Não virou</button>
          <button class="btn btn--tiny btn--ghost icon-button" type="button" data-action="later">${ICONS.clock} Depois</button>
        </div>
      `;
      leadsTableWrap.innerHTML = "";
      leadsTableWrap.appendChild(demoRow);
      demoState.demoLeadInserted = true;
    }

    function cleanupDemoLeadRow() {
      if (!demoState.demoLeadInserted) return;
      const demoRow = document.querySelector(".demo-lead-row");
      if (demoRow) demoRow.remove();
      if (demoState.prevActionState) {
        setActionState(demoState.prevActionState);
      }
      demoState.demoLeadInserted = false;
      demoState.prevActionState = null;
    }

    function resolveTarget(step) {
      if (!step) return null;
      const target = step.target ? step.target() : null;
      if (target) return target;
      if (step.fallback) return step.fallback();
      return null;
    }

    function positionHighlight(target) {
      if (!target) {
        demoState.highlight.style.display = "none";
        return;
      }
      const rect = target.getBoundingClientRect();
      const padding = 10;
      demoState.highlight.style.display = "block";
      demoState.highlight.style.top = `${Math.max(rect.top - padding, 8)}px`;
      demoState.highlight.style.left = `${Math.max(rect.left - padding, 8)}px`;
      demoState.highlight.style.width = `${Math.min(rect.width + padding * 2, window.innerWidth - 16)}px`;
      demoState.highlight.style.height = `${Math.min(rect.height + padding * 2, window.innerHeight - 16)}px`;
    }

    function positionTooltip(target) {
      const tooltip = demoState.tooltip;
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      tooltip.classList.toggle("tour-tooltip--mobile", isMobile);
      if (isMobile) {
        tooltip.style.top = "";
        tooltip.style.left = "";
        tooltip.style.transform = "";
        return;
      }
      if (!target) {
        tooltip.style.top = "50%";
        tooltip.style.left = "50%";
        tooltip.style.transform = "translate(-50%, -50%)";
        return;
      }
      const rect = target.getBoundingClientRect();
      const margin = 16;
      const tooltipRect = tooltip.getBoundingClientRect();
      let top = rect.bottom + margin;
      let left = rect.left;
      if (top + tooltipRect.height > window.innerHeight) {
        top = rect.top - tooltipRect.height - margin;
      }
      if (left + tooltipRect.width > window.innerWidth) {
        left = window.innerWidth - tooltipRect.width - margin;
      }
      if (left < margin) left = margin;
      tooltip.style.top = `${Math.max(top, margin)}px`;
      tooltip.style.left = `${left}px`;
      tooltip.style.transform = "";
    }

    function updateStepUI(step, index) {
      demoState.progress.textContent = `Passo ${index + 1}/${steps.length}`;
      demoState.title.textContent = step.title;
      demoState.body.textContent = step.text;
      demoState.helper.textContent = "";
      demoState.btnPrev.style.display = index === 0 ? "none" : "inline-flex";
      demoState.btnNext.style.display = step.isFinal ? "none" : "inline-flex";
      demoState.btnFinish.closest(".tour-actions--final").style.display = step.isFinal ? "flex" : "none";

      if (step.requireAction) {
        demoState.actionDone = false;
        demoState.btnNext.disabled = true;
        demoState.helper.textContent = "Clique em Virou ou Não virou para continuar.";
      } else {
        demoState.btnNext.disabled = false;
      }
    }

    function goToStep(index) {
      if (index < 0 || index >= steps.length) return;
      const step = steps[index];
      if (!step.requireAction) {
        cleanupDemoLeadRow();
      }
      if (step.requireAction) ensureDemoLeadRow();
      const target = resolveTarget(step);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
      }
      if (!step.isFinal && !target) {
        goToStep(index + 1);
        return;
      }
      demoState.current = index;
      updateStepUI(step, index);
      positionHighlight(target);
      positionTooltip(target);
    }

    function startDemo() {
      buildTourUI();
      cleanupDemoLeadRow();
      demoState.active = true;
      demoState.overlay.style.display = "block";
      demoState.tooltip.style.display = "block";
      goToStep(0);
    }

    function nextStep() {
      if (!demoState.active) return;
      goToStep(demoState.current + 1);
    }

    function prevStep() {
      if (!demoState.active) return;
      goToStep(demoState.current - 1);
    }

    function endDemo(completed) {
      localStorage.setItem(DEMO_KEY, "true");
      demoState.active = false;
      if (demoState.overlay) demoState.overlay.style.display = "none";
      if (demoState.tooltip) demoState.tooltip.style.display = "none";
      cleanupDemoLeadRow();
    }

    window.addEventListener("resize", () => {
      if (!demoState.active) return;
      const step = steps[demoState.current];
      const target = resolveTarget(step);
      positionHighlight(target);
      positionTooltip(target);
    });

    leadsTableWrap.addEventListener("click", (event) => {
      if (!demoState.active) return;
      const step = steps[demoState.current];
      if (!step || !step.requireAction) return;
      const button = event.target.closest("[data-action]");
      if (!button) return;
      if (button.dataset.action !== "convert" && button.dataset.action !== "deny") return;
      demoState.actionDone = true;
      demoState.btnNext.disabled = false;
      demoState.helper.textContent = "Perfeito! Você já pode continuar.";
    });

    const bindRestartBtn = () => {
      const restartBtn = resolveRestartBtn();
      if (!restartBtn || restartBtn.dataset.bound === "true") {
        return;
      }
      restartBtn.dataset.bound = "true";
      restartBtn.addEventListener("click", () => {
        localStorage.removeItem(DEMO_KEY);
        startDemo();
      });
    };

    document.addEventListener("site-shell:header-ready", bindRestartBtn);
    bindRestartBtn();

    if (!localStorage.getItem(DEMO_KEY)) {
      window.setTimeout(startDemo, 600);
    }
  </script>
</body>
</html>
