<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LeadRank • Experimente Grátis</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="page">
    <header class="site-header">
      <a class="brand" href="landing.html">
        <span class="brand__logo">LR</span>
        <span class="brand__text">LeadRank</span>
      </a>
      <nav class="site-nav">
        <a href="landing.html">Início</a>
        <a href="pricing.html">Planos</a>
        <a href="onboarding.html" aria-current="page">Criar conta</a>
        <a href="login.html">Entrar</a>
      </nav>
      <a class="btn btn--ghost" href="index.html">Acessar dashboard</a>
    </header>

    <main>
      <section class="auth">
        <div class="auth__copy">
          <p class="eyebrow" id="authEyebrow">Experimente grátis</p>
          <h1 id="authTitle">Comece agora com o LeadRank</h1>
          <p class="subtitle" id="authSubtitle">
            Teste por 14 dias. Sem cartão. Crie sua conta em segundos e receba suas credenciais de integração.
          </p>
          <div class="auth__steps" id="authSteps">
            <div>
              <span class="step">1</span>
              <p>Crie sua conta e receba client_id e api_key.</p>
            </div>
            <div>
              <span class="step">2</span>
              <p>Envie leads via API ou use o dashboard.</p>
            </div>
            <div>
              <span class="step">3</span>
              <p>Monitore taxas de conversão e prioridades.</p>
            </div>
          </div>
        </div>

        <div class="auth__card">
          <form id="signupForm" class="form">
            <h2>Criar conta gratuita</h2>
            <label>
              Nome completo
              <input type="text" id="nome" required placeholder="João Silva" />
            </label>
            <label>
              Email profissional
              <input type="email" id="email" required placeholder="joao@empresa.com" />
            </label>
            <label>
              Empresa / Marca (opcional)
              <input type="text" id="empresa" placeholder="Minha Empresa" />
            </label>
            <label>
              WhatsApp (opcional)
              <input type="tel" id="telefone" placeholder="(11) 98765-4321" />
            </label>
            <label>
              Senha
              <input type="password" id="password" required minlength="6" placeholder="Mínimo 6 caracteres" />
            </label>
            <button type="submit" class="btn btn--block" id="submitBtn">Criar conta trial grátis</button>
          </form>

          <form id="loginForm" class="form" style="display:none">
            <h2>Entrar no LeadRank</h2>
            <label>
              Email
              <input type="email" id="login_email" required placeholder="joao@empresa.com" />
            </label>
            <label>
              Senha
              <input type="password" id="login_password" required placeholder="Sua senha" />
            </label>
            <button type="submit" class="btn btn--block" id="loginBtn">Entrar</button>
          </form>

          <div class="alert" id="loading">Processando sua solicitação...</div>
          <div class="alert" id="success"></div>
          <div class="alert" id="error"></div>

          <p class="form__hint">
            Já tem uma conta? <a href="onboarding.html?mode=login">Entre por aqui</a>.
          </p>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <span>© 2024 LeadRank. Todos os direitos reservados.</span>
      <div class="footer__links">
        <a href="landing.html">Início</a>
        <a href="pricing.html">Planos</a>
        <a href="login.html">Entrar</a>
      </div>
    </footer>
  </div>

  <script>
    const BACKEND = (window.BACKEND_URL || "https://qualificador-leads-i-a.onrender.com").replace(/\/$/, "");

    const form = document.getElementById("signupForm");
    const submitBtn = document.getElementById("submitBtn");
    const loading = document.getElementById("loading");
    const successDiv = document.getElementById("success");
    const errorDiv = document.getElementById("error");

    const qs = (k) => new URLSearchParams(location.search).get(k) || "";
    const mode = (qs("mode") || "signup").toLowerCase();
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");

    const authTitle = document.getElementById("authTitle");
    const authSubtitle = document.getElementById("authSubtitle");
    const authEyebrow = document.getElementById("authEyebrow");
    const authSteps = document.getElementById("authSteps");

    if (mode === "login") {
      authTitle.textContent = "Entrar no LeadRank";
      authSubtitle.textContent = "Acesse seu dashboard com email e senha.";
      authEyebrow.textContent = "Acesso seguro";
      if (authSteps) authSteps.style.display = "none";
      form.style.display = "none";
      loginForm.style.display = "grid";
    }

    function setAuth(clientId, apiKey) {
      if (clientId) {
        localStorage.setItem("leadrank_client_id", clientId);
        localStorage.setItem("client_id", clientId);
        localStorage.setItem("LR_CLIENT_ID", clientId);
      }
      if (apiKey) {
        localStorage.setItem("leadrank_api_key", apiKey);
        localStorage.setItem("api_key", apiKey);
        localStorage.setItem("LR_API_KEY", apiKey);
      }
    }

    function redirectToDashboard(clientId, apiKey) {
      window.location.href = `index.html?client_id=${encodeURIComponent(clientId || "")}&api_key=${encodeURIComponent(apiKey || "")}`;
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.className = "alert alert--error";
    }

    function showLoading(msg) {
      loading.textContent = msg;
      loading.className = "alert";
      loading.style.display = "block";
    }

    function showSuccess(msg) {
      successDiv.textContent = msg;
      successDiv.className = "alert alert--success";
    }

    function resetAlerts() {
      loading.style.display = "none";
      successDiv.className = "alert";
      errorDiv.className = "alert";
    }

    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login_email").value.trim().toLowerCase();
        const password = document.getElementById("login_password").value.trim();

        if (!email || !password) {
          showError("Email e senha são obrigatórios.");
          return;
        }

        loginBtn.disabled = true;
        resetAlerts();
        showLoading("Validando credenciais...");

        try {
          const res = await fetch(BACKEND + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            throw new Error(data.error || data.message || ("Erro HTTP " + res.status));
          }

          const clientId = data.client_id;
          const apiKey = data.api_key;

          setAuth(clientId, apiKey);
          resetAlerts();
          showSuccess("Login realizado. Redirecionando...");

          setTimeout(() => redirectToDashboard(clientId, apiKey), 400);
        } catch (err) {
          resetAlerts();
          showError(err.message || "Erro de conexão. Tente novamente.");
        } finally {
          loginBtn.disabled = false;
          loading.style.display = "none";
        }
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nome = document.getElementById("nome").value.trim();
      const email = document.getElementById("email").value.trim().toLowerCase();
      const empresa = document.getElementById("empresa").value.trim();
      const telefone = document.getElementById("telefone").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!nome || !email) {
        showError("Nome e email são obrigatórios.");
        return;
      }

      submitBtn.disabled = true;
      resetAlerts();
      showLoading("Criando sua conta...");

      try {
        const res = await fetch(BACKEND + "/signup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome, email, empresa, telefone, password })
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          throw new Error(data.error || data.message || ("Erro HTTP " + res.status));
        }

        const clientId = data.client_id;
        const apiKey = data.api_key;

        setAuth(clientId, apiKey);
        resetAlerts();
        showSuccess("Conta criada com sucesso. Redirecionando para o dashboard...");

        setTimeout(() => redirectToDashboard(clientId, apiKey), 600);
      } catch (err) {
        resetAlerts();
        showError(err.message || "Erro de conexão. Tente novamente.");
      } finally {
        submitBtn.disabled = false;
        loading.style.display = "none";
      }
    });
  </script>
</body>
</html>
